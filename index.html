<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ëª¨ë‘ì˜ ìˆ˜ì‹œ 3ê°œë…„ ì…ì‹œê²°ê³¼ ë¹„êµ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: linear-gradient(180deg, #ffe6d5 0%, #ffeef9 50%, #e9f6ff 100%);
  color: #222;
}

.page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 12px 10px 60px;
}

/* ì œëª© ì˜ì—­ */
h1 {
  margin: 6px 0 4px;
  font-size: 26px;
  font-weight: 900;
}
.sub-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 2px;
}
.meta {
  font-size: 13px;
  font-weight: 800;
}

/* ì¹´ë“œ ê³µí†µ */
.card {
  background: #ffffff;
  border-radius: 18px;
  padding: 14px 16px;
  margin-top: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.10);
}

/* ê²€ìƒ‰ ì¹´ë“œ */
.card-search {
  box-shadow: 0 12px 32px rgba(0,0,0,0.12);
}

/* í˜„ì¬ ì„ íƒ vs ë¹„êµ ì¹´ë“œ */
.card-current {
  border-top: 6px solid #ff7a6d;
}
.card-compare {
  border-top: 6px solid #6b9bff;
}

/* ì¹´ë“œ ì œëª© */
.card-title {
  font-size: 15px;
  font-weight: 900;
  margin-bottom: 8px;
}

/* ê²€ìƒ‰ ì˜ì—­ 4ê°œ select + ë²„íŠ¼ */
.search-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  margin-bottom: 8px;
}
.search-row .field {
  flex: 1 1 0;
  min-width: 120px;
}

select {
  width: 100%;
  padding: 11px 12px;
  border-radius: 14px;
  border: 2px solid #ffb28b;
  font-size: 15px;
  font-weight: 800;
  background: #fffdfb;
}

/* ë²„íŠ¼ */
.btn-row {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 6px;
}
.btn {
  padding: 10px 16px;
  border-radius: 14px;
  border: none;
  font-size: 14px;
  font-weight: 900;
  cursor: pointer;
  white-space: nowrap;
}
.btn-main {
  background: linear-gradient(120deg,#ff7b61,#ff3d7a);
  color: #fff;
}
.btn-sub {
  background: #ffffff;
  border: 2px solid #eeeeee;
  color: #444;
}
.btn-ghost {
  background: #f7f9ff;
  border: 2px solid #e8eeff;
  color: #2f4ecb;
}

/* ëª¨ë°”ì¼ì—ì„œ select / ë²„íŠ¼ í¬ê²Œ */
@media (max-width: 700px) {
  select {
    font-size: 17px;
    padding: 14px;
  }
  .btn {
    font-size: 16px;
    flex: 1 1 0;
    justify-content: center;
  }
  .btn-row {
    flex-wrap: wrap;
  }
}

/* ê²°ê³¼ ì„¤ëª… */
.result-header {
  font-size: 14px;
  font-weight: 800;
  margin-bottom: 4px;
}
.result-title {
  font-size: 15px;
  font-weight: 900;
}
.result-sub {
  font-size: 13px;
  color: #555;
  margin-bottom: 6px;
}

/* =========================
   SCORE TOWER (ì…ê²° ìƒìŠ¹ íƒ€ì›Œ)
========================= */
.tower-stage {
  position: relative;
  border-radius: 18px;
  padding: 14px 12px 12px;
  background: linear-gradient(180deg, #ffffff 0%, #fff7fb 45%, #f3fbff 100%);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03);
  overflow: hidden;
}

.tower-stage::before{
  content:"";
  position:absolute;
  inset:-40px -60px auto -60px;
  height:120px;
  background: radial-gradient(circle at 50% 50%, rgba(255,120,160,0.14), transparent 60%);
  filter: blur(2px);
}

.tower-wrap {
  display: flex;
  gap: 18px;
  justify-content: center;
  align-items: flex-end;
  margin: 10px 0 6px;
}

@media (max-width: 700px) {
  .tower-wrap { gap: 12px; }
}

.tower {
  width: 92px;
  text-align: center;
  font-weight: 900;
  position: relative;
}

.tower-year {
  font-size: 13px;
  margin-bottom: 6px;
  opacity: .9;
}

.tower-pillar {
  position: relative;
  height: 210px;
  border-radius: 16px;
  background: linear-gradient(180deg,#f8f8f8,#e9e9e9);
  box-shadow: inset 0 0 10px rgba(0,0,0,.12);
  overflow: hidden;
}

@media (max-width: 700px) {
  .tower-pillar { height: 160px; }
}

.tower-fill {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  border-radius: 16px;
  transition: height 1s cubic-bezier(.2,.9,.25,1);
  transform: translateZ(0);
}

/* shimmer overlay */
.tower-fill::after{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(120deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.38) 35%, rgba(255,255,255,0.0) 70%);
  transform: translateX(-140%);
  animation: shimmer 1.2s ease-in-out 0.2s 1;
}

@keyframes shimmer {
  0%   { transform: translateX(-140%); opacity: .0; }
  30%  { opacity: .9; }
  100% { transform: translateX(140%); opacity: .0; }
}

/* ì—°ë„ë³„ ì»¬ëŸ¬ */
.tower-2023 { background: linear-gradient(180deg,#6aa8ff,#3f6cff); }
.tower-2024 { background: linear-gradient(180deg,#ffce55,#ff9f1c); }
.tower-2025 {
  background: linear-gradient(180deg,#ff6b6b,#ff2d2d);
  box-shadow: 0 0 18px rgba(255,70,70,.45);
}

/* ìƒë‹¨ sparkle */
.spark {
  position:absolute;
  top:-16px;
  left:50%;
  transform: translateX(-50%);
  width: 54px;
  height: 54px;
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.95), rgba(255,255,255,0.0) 65%);
  opacity: 0;
  pointer-events:none;
}
.spark.on {
  animation: pop 0.9s ease-out 0.1s 1;
}
@keyframes pop {
  0%   { transform: translateX(-50%) scale(.4); opacity: 0; }
  35%  { transform: translateX(-50%) scale(1.1); opacity: .95; }
  100% { transform: translateX(-50%) scale(1.6); opacity: 0; }
}

.tower-value {
  margin-top: 7px;
  font-size: 18px;
}

/* ìƒìŠ¹ ë¼ë²¨ (ì—°ê²° í™”ì‚´í‘œ ëŠë‚Œ) */
.tower-badge {
  position: absolute;
  top: 34px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  background: #ff4d4d;
  color: #fff;
  padding: 3px 9px;
  border-radius: 999px;
  box-shadow: 0 8px 18px rgba(255,77,77,.24);
  opacity: 0;
}
.tower-badge.on {
  animation: badgeIn .8s ease-out .15s 1 forwards;
}
@keyframes badgeIn {
  0% { transform: translateX(-50%) translateY(6px) scale(.92); opacity: 0; }
  60%{ opacity: 1; }
  100%{ transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
}

/* =========================
   TABLE
========================= */
table.result-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 14px;
}
table.result-table th,
table.result-table td {
  text-align: center;
  padding: 7px 4px;
  border-bottom: 1px solid #eeeeee;
  border-right: 1px solid #eeeeee;
}
table.result-table th:last-child,
table.result-table td:last-child {
  border-right: none;
}
table.result-table th {
  background: #fff3eb;
  font-weight: 900;
}
table.result-table tr.highlight-2025 {
  background: #fff8d7;
  font-weight: 900;
  font-size: 15px;
}

/* ì¦ê° í…ìŠ¤íŠ¸ */
.diff-up { color: #e53935; font-weight: 900; }
.diff-down { color: #1e88e5; font-weight: 900; }
.diff-same { color: #555; }

/* ë¹„êµ ì¹´ë“œ ë‚´ë¶€ */
.compare-controls {
  display:flex;
  gap:8px;
  align-items:center;
  justify-content: space-between;
  margin-bottom: 6px;
  flex-wrap: wrap;
}
.pill {
  font-size: 12px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  background: #f1f5ff;
  color: #2f4ecb;
  border: 1px solid #e3ebff;
}
.compare-item {
  margin-top: 8px;
  padding: 10px 10px 12px;
  border-radius: 14px;
  border: 2px dashed #dde5ff;
  background: #ffffff;
}
.compare-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
  gap: 8px;
}
.compare-label {
  font-size: 13px;
  font-weight: 900;
}
.compare-label small {
  font-size: 11px;
  color: #777;
}
.compare-index-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background: #6b9bff;
  color: #fff;
  font-size: 11px;
  margin-right: 6px;
}
.btn-mini {
  padding: 6px 10px;
  border-radius: 999px;
  border: none;
  font-size: 12px;
  font-weight: 900;
  cursor: pointer;
  background: #f7f7ff;
}

/* ë¹ˆ ìƒíƒœ ì•ˆë‚´ */
.empty-text {
  font-size: 13px;
  color: #555;
}

/* =========================
   COMPARE SLIDER MODE
========================= */
.compare-slider {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding: 6px 2px 10px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}
.compare-slider::-webkit-scrollbar { height: 10px; }
.compare-slider::-webkit-scrollbar-thumb {
  background: rgba(70,110,255,0.18);
  border-radius: 999px;
}
.compare-slide {
  scroll-snap-align: center;
  flex: 0 0 380px;
  max-width: 380px;
}
@media (max-width: 700px) {
  .compare-slide {
    flex: 0 0 88%;
    max-width: 88%;
  }
}

/* ëª¨ë°”ì¼ ìš”ì•½ ì¹´ë“œ */
.mobile-summary {
  display: none;
  margin-top: 10px;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid #eef1ff;
}
.mobile-summary .row {
  display:flex;
  justify-content: space-between;
  padding: 10px 12px;
  background: #fbfcff;
  border-bottom: 1px solid #eef1ff;
  font-weight: 900;
}
.mobile-summary .row:last-child { border-bottom: none; }
.mobile-summary .row span:first-child { color:#334; font-size: 13px; }
.mobile-summary .row span:last-child { color:#111; font-size: 13px; }
@media (max-width: 700px) {
  .mobile-only { display: block !important; }
  .desktop-only { display: none !important; }
  .mobile-summary { display: block; }
}

/* ì ‘ê¸°/í¼ì¹˜ê¸° */
details.fold {
  margin-top: 10px;
  border: 1px solid #f0f0f0;
  border-radius: 14px;
  overflow: hidden;
}
details.fold summary {
  cursor: pointer;
  list-style: none;
  padding: 10px 12px;
  font-weight: 900;
  background: #fff7fb;
}
details.fold summary::-webkit-details-marker { display: none; }
details.fold .inner {
  padding: 10px 12px 12px;
  background: #ffffff;
}
</style>
</head>

<body>
<div class="page">
  <h1>ëª¨ë‘ì˜ ìˆ˜ì‹œ 3ê°œë…„ ì…ì‹œê²°ê³¼ ë¹„êµ</h1>
  <div class="sub-title">ëŒ€í•™ Â· ëª¨ì§‘ë‹¨ìœ„ Â· ì „í˜•ìœ í˜• Â· ì„¸ë¶€ì „í˜•ì„ ì„ íƒí•˜ì—¬ 3ê°œë…„ 70% cutì„ í•œëˆˆì— ë¹„êµí•˜ì„¸ìš”.</div>
  <div class="meta">Copyright @All Teachers</div>
  <div class="meta">ì¶œì²˜: 3ê°œë…„ ì–´ë””ê°€ ìˆ˜ì‹œ ì…ì‹œê²°ê³¼</div>

  <!-- ê²€ìƒ‰ ì¹´ë“œ -->
  <div class="card card-search">
    <div class="card-title">ê²€ìƒ‰ ê¸°ì¤€ ì„ íƒ (ê°€ë¡œ 4ê°œ ë“œë¡­ë‹¤ìš´)</div>
    <div class="search-row">
      <div class="field">
        <select id="univSelect">
          <option value="">ëŒ€í•™ ì„ íƒ</option>
        </select>
      </div>
      <div class="field">
        <select id="majorSelect" disabled>
          <option value="">ëª¨ì§‘ë‹¨ìœ„ ì„ íƒ</option>
        </select>
      </div>
      <div class="field">
        <select id="typeSelect" disabled>
          <option value="">ì „í˜•ìœ í˜• ì„ íƒ</option>
        </select>
      </div>
      <div class="field">
        <select id="detailSelect" disabled>
          <option value="">ì„¸ë¶€ì „í˜• ì„ íƒ</option>
        </select>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-main" id="addCompareBtn" disabled>ï¼‹ ë¹„êµ ì¶”ê°€ (ìµœëŒ€ 3ê°œ)</button>
      <button class="btn btn-ghost" id="toggleCompareViewBtn">â†” ë¹„êµ ìŠ¬ë¼ì´ë“œ ë³´ê¸°</button>
      <button class="btn btn-sub" id="resetBtn">ì„ íƒ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <!-- í˜„ì¬ ì„ íƒ ê²°ê³¼ -->
  <div class="card card-current">
    <div class="card-title">í˜„ì¬ ì„ íƒ 1ê°œ ì „í˜•ì˜ 3ê°œë…„ ê²°ê³¼</div>
    <div id="currentResult">
      <p class="empty-text">
        ì•„ì§ ì„ íƒëœ ì „í˜•ì´ ì—†ìŠµë‹ˆë‹¤.<br>
        ìœ„ì—ì„œ ëŒ€í•™ â†’ ëª¨ì§‘ë‹¨ìœ„ â†’ ì „í˜•ìœ í˜• â†’ ì„¸ë¶€ì „í˜•ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.
      </p>
    </div>
  </div>

  <!-- ë¹„êµ ëª©ë¡ -->
  <div class="card card-compare">
    <div class="compare-controls">
      <div class="card-title" style="margin:0;">ì„ íƒ ë¹„êµ ëª©ë¡ (ìµœëŒ€ 3ê°œê¹Œì§€ ëˆ„ì )</div>
      <div class="pill" id="compareModePill">ì„¸ë¡œ ëª¨ë“œ</div>
    </div>
    <div class="empty-text" id="compareEmpty">ë¹„êµ ëª©ë¡ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. 'ë¹„êµ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì „í˜•ì„ ëˆ„ì í•˜ì„¸ìš”.</div>
    <div id="compareList"></div>
  </div>
</div>

<script>
const YEARS = [2025, 2024, 2023];
let DATA = [];
let INDEX = {};   // {ëŒ€í•™->{ëª¨ì§‘ë‹¨ìœ„->{ì¤‘ì‹¬ì „í˜•->{ì „í˜•ëª…->{ì—°ë„:row}}}}}
let compareSelections = [];
let compareSliderMode = false;

const univSelect   = document.getElementById("univSelect");
const majorSelect  = document.getElementById("majorSelect");
const typeSelect   = document.getElementById("typeSelect");
const detailSelect = document.getElementById("detailSelect");
const addCompareBtn = document.getElementById("addCompareBtn");
const resetBtn       = document.getElementById("resetBtn");
const toggleCompareViewBtn = document.getElementById("toggleCompareViewBtn");
const compareModePill = document.getElementById("compareModePill");

const currentResultBox = document.getElementById("currentResult");
const compareListBox   = document.getElementById("compareList");
const compareEmptyText = document.getElementById("compareEmpty");

/* ìœ í‹¸ */
function extractYear(value) {
  const s = String(value ?? "");
  const m = s.match(/(\d{4})/);
  return m ? m[1] : null;
}
function isMobile() {
  return window.matchMedia && window.matchMedia("(max-width: 700px)").matches;
}
function fillSelect(select, items, placeholder) {
  select.innerHTML = "";
  const opt = document.createElement("option");
  opt.value = "";
  opt.textContent = placeholder;
  select.appendChild(opt);
  items.forEach(v => {
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    select.appendChild(o);
  });
}
function disableSelect(sel, message) {
  sel.disabled = true;
  sel.innerHTML = "";
  const opt = document.createElement("option");
  opt.value = "";
  opt.textContent = message;
  sel.appendChild(opt);
}

/* ë°ì´í„° ë¡œë“œ & ì¸ë±ìŠ¤ ìƒì„± */
async function loadData() {
  try {
    const res = await fetch("data/data.json");
    const raw = await res.json();
    DATA = raw || [];
    buildIndex();
    initUnivSelect();
  } catch (e) {
    console.error(e);
    univSelect.innerHTML = "<option value=''>data/data.json ë¡œë“œ ì‹¤íŒ¨</option>";
    alert("data/data.json ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê²½ë¡œ/íŒŒì¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }
}

function buildIndex() {
  INDEX = {};
  for (const row of DATA) {
    const univ = row["ëŒ€í•™ëª…"];
    const major = row["ëª¨ì§‘ë‹¨ìœ„"];
    const type  = row["ì¤‘ì‹¬ì „í˜•"];
    const detail= row["ì „í˜•ëª…"];
    const y = extractYear(row["ì—°ë„"]);
    if (!univ || !major || !type || !detail || !y) continue;

    if (!INDEX[univ]) INDEX[univ] = {};
    if (!INDEX[univ][major]) INDEX[univ][major] = {};
    if (!INDEX[univ][major][type]) INDEX[univ][major][type] = {};
    if (!INDEX[univ][major][type][detail]) INDEX[univ][major][type][detail] = {};
    INDEX[univ][major][type][detail][y] = row;
  }
}

function initUnivSelect() {
  const univs = Object.keys(INDEX).sort((a,b)=>a.localeCompare(b,"ko"));
  fillSelect(univSelect, univs, "ëŒ€í•™ ì„ íƒ");
  univSelect.disabled = false;
}

/* ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ */
univSelect.addEventListener("change", () => {
  const univ = univSelect.value;
  disableSelect(majorSelect, "ëª¨ì§‘ë‹¨ìœ„ ì„ íƒ");
  disableSelect(typeSelect, "ì „í˜•ìœ í˜• ì„ íƒ");
  disableSelect(detailSelect, "ì„¸ë¶€ì „í˜• ì„ íƒ");
  addCompareBtn.disabled = true;
  renderCurrentResult(null);

  if (!univ || !INDEX[univ]) return;
  const majors = Object.keys(INDEX[univ]).sort((a,b)=>a.localeCompare(b,"ko"));
  fillSelect(majorSelect, majors, "ëª¨ì§‘ë‹¨ìœ„ ì„ íƒ");
  majorSelect.disabled = false;
});

majorSelect.addEventListener("change", () => {
  const univ = univSelect.value;
  const major = majorSelect.value;
  disableSelect(typeSelect, "ì „í˜•ìœ í˜• ì„ íƒ");
  disableSelect(detailSelect, "ì„¸ë¶€ì „í˜• ì„ íƒ");
  addCompareBtn.disabled = true;
  renderCurrentResult(null);

  if (!univ || !major || !INDEX[univ] || !INDEX[univ][major]) return;
  const types = Object.keys(INDEX[univ][major]).sort((a,b)=>a.localeCompare(b,"ko"));
  fillSelect(typeSelect, types, "ì „í˜•ìœ í˜• ì„ íƒ");
  typeSelect.disabled = false;
});

typeSelect.addEventListener("change", () => {
  const univ = univSelect.value;
  const major= majorSelect.value;
  const type = typeSelect.value;
  disableSelect(detailSelect, "ì„¸ë¶€ì „í˜• ì„ íƒ");
  addCompareBtn.disabled = true;
  renderCurrentResult(null);

  if (!univ || !major || !type || !INDEX[univ]?.[major]?.[type]) return;
  const details = Object.keys(INDEX[univ][major][type]).sort((a,b)=>a.localeCompare(b,"ko"));
  fillSelect(detailSelect, details, "ì„¸ë¶€ì „í˜• ì„ íƒ");
  detailSelect.disabled = false;
});

detailSelect.addEventListener("change", () => {
  const univ = univSelect.value;
  const major= majorSelect.value;
  const type = typeSelect.value;
  const detail = detailSelect.value;

  const valid = univ && major && type && detail;
  addCompareBtn.disabled = !valid;

  if (!valid) return renderCurrentResult(null);

  const selection = { univ, major, type, detail };
  renderCurrentResult(selection);
});

/* ì„ íƒëœ ì „í˜•ì˜ 3ê°œë…„ row ê°€ì ¸ì˜¤ê¸° */
function getRowsForSelection(sel) {
  if (!sel) return null;
  const { univ, major, type, detail } = sel;
  const rowsByYear = {};
  YEARS.forEach(y => {
    const key = String(y);
    rowsByYear[y] = INDEX[univ]?.[major]?.[type]?.[detail]?.[key] || null;
  });
  return rowsByYear;
}

/* ì¦ê° í…ìŠ¤íŠ¸ ìƒì„± (70% cut ê¸°ì¤€) */
function createDiffText(currentRow, prevRow) {
  if (!currentRow || !prevRow) return { html: "-", cls: "diff-same" };

  const c = Number(currentRow["70% cut"]);
  const p = Number(prevRow["70% cut"]);
  if (Number.isNaN(c) || Number.isNaN(p)) return { html: "-", cls: "diff-same" };

  const diff = (p - c); // ì´ì „ - ì§€ê¸ˆ
  if (diff > 0) return { html: `â–² ${Math.abs(diff).toFixed(2)} ìƒìŠ¹`, cls: "diff-up" };
  if (diff < 0) return { html: `â–¼ ${Math.abs(diff).toFixed(2)} í•˜ë½`, cls: "diff-down" };
  return { html: "â– ë™ì¼", cls: "diff-same" };
}

/* í…Œì´ë¸” (PC ê¸°ë³¸: ê¸°ì¡´ í’€ í…Œì´ë¸”) */
function createTableBlock(rowsByYear) {
  const table = document.createElement("table");
  table.className = "result-table";

  const headerRow = document.createElement("tr");
  ["ì—°ë„","50% cut","70% cut","ì¦ê°(70%)","ëª¨ì§‘ì¸ì›","ê²½ìŸë¥ ","ì¶©ì›ìˆœìœ„"].forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    headerRow.appendChild(th);
  });
  table.appendChild(headerRow);

  YEARS.forEach((year, idx) => {
    const tr = document.createElement("tr");
    if (year === 2025) tr.classList.add("highlight-2025");

    const row = rowsByYear[year];
    const prevYear = YEARS[idx+1];
    const prevRow = rowsByYear[prevYear];
    const diff = createDiffText(row, prevRow);

    function val(key) {
      if (!row || row[key] == null || row[key] === "") return "-";
      return row[key];
    }

    const cols = [
      year,
      val("50% cut"),
      val("70% cut"),
      { diff: diff },
      val("ëª¨ì§‘ì¸ì›"),
      val("ê²½ìŸë¥ "),
      val("ì¶©ì›ìˆœìœ„")
    ];

    cols.forEach((v, i) => {
      const td = document.createElement("td");
      if (i === 3 && v && v.diff) {
        td.innerHTML = `<span class="${v.diff.cls}">${v.diff.html}</span>`;
      } else {
        td.textContent = v;
      }
      tr.appendChild(td);
    });

    table.appendChild(tr);
  });

  return table;
}

/* ëª¨ë°”ì¼ ìš”ì•½ ì¹´ë“œ (70% cut ì¤‘ì‹¬) */
function createMobileSummary(rowsByYear) {
  const box = document.createElement("div");
  box.className = "mobile-summary";

  YEARS.forEach((year, idx) => {
    const row = rowsByYear[year];
    const prevYear = YEARS[idx+1];
    const prevRow = rowsByYear[prevYear];
    const diff = createDiffText(row, prevRow);

    const v = row && row["70% cut"] !== "" && row["70% cut"] != null ? Number(row["70% cut"]) : null;
    const text = (v !== null && !Number.isNaN(v)) ? `${v.toFixed(2)}ë“±ê¸‰` : "-";

    const r = document.createElement("div");
    r.className = "row";
    r.innerHTML = `
      <span>${year} Â· 70% cut</span>
      <span>${text} <em style="font-style:normal; margin-left:6px;" class="${diff.cls}">${diff.html}</em></span>
    `;
    box.appendChild(r);
  });

  return box;
}

/* ======= ì…ê²° ìƒìŠ¹ íƒ€ì›Œ (ì˜¨ë„ê³„ ì™„ì „ êµì²´) ======= */
function createScoreTowerBlock(rowsByYear) {
  const stage = document.createElement("div");
  stage.className = "tower-stage";

  const wrap = document.createElement("div");
  wrap.className = "tower-wrap";

  YEARS.forEach((year, idx) => {
    const col = document.createElement("div");
    col.className = "tower";

    const label = document.createElement("div");
    label.className = "tower-year";
    label.textContent = year + "í•™ë…„ë„";
    col.appendChild(label);

    const pillar = document.createElement("div");
    pillar.className = "tower-pillar";

    const fill = document.createElement("div");
    fill.className = `tower-fill tower-${year}`;

    const spark = document.createElement("div");
    spark.className = "spark";

    const row = rowsByYear[year];
    let value = null;
    if (row && row["70% cut"] !== undefined && row["70% cut"] !== "") {
      const n = Number(row["70% cut"]);
      if (!Number.isNaN(n)) value = n;
    }

    // ë†’ì´ ë§¤í•‘ (ë“±ê¸‰ ë‚®ì„ìˆ˜ë¡ ë†’ê²Œ)
    let height = 6;
    if (value !== null) {
      const norm = (6 - value) / 5;  // 1ë“±ê¸‰->1, 6ë“±ê¸‰->0
      const exaggerated = Math.pow(Math.max(0, Math.min(1, norm)), 1.25);
      height = 10 + exaggerated * 85;
    }

    // ìƒìŠ¹ ë°°ì§€ (ì´ì „ë…„ë„ ëŒ€ë¹„)
    const prevYear = YEARS[idx + 1];
    let badgeText = "";
    if (prevYear && rowsByYear[prevYear] && value !== null) {
      const prev = Number(rowsByYear[prevYear]["70% cut"]);
      if (!Number.isNaN(prev)) {
        const diff = prev - value; // ì´ì „ - í˜„ì¬ (ì–‘ìˆ˜ë©´ ìƒìŠ¹)
        if (diff > 0) badgeText = `â–² +${diff.toFixed(2)}`;
        else if (diff < 0) badgeText = `â–¼ -${Math.abs(diff).toFixed(2)}`;
        else badgeText = `â– 0.00`;
      }
    }

    const badge = document.createElement("div");
    badge.className = "tower-badge";
    if (badgeText) badge.textContent = badgeText;

    pillar.appendChild(fill);
    pillar.appendChild(spark);
    if (badgeText) pillar.appendChild(badge);

    col.appendChild(pillar);

    const valueText = document.createElement("div");
    valueText.className = "tower-value";
    valueText.textContent = value !== null ? value.toFixed(2) + "ë“±ê¸‰" : "ë°ì´í„° ì—†ìŒ";
    col.appendChild(valueText);

    // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
    setTimeout(() => {
      fill.style.height = height + "%";
      // ë°˜ì§ì„(íŠ¹íˆ 2025 ê°•ì¡°)
      spark.classList.add("on");
      if (badgeText) badge.classList.add("on");
      if (year === 2025) {
        setTimeout(()=>spark.classList.add("on"), 180);
      }
    }, 80 + (idx * 90));

    wrap.appendChild(col);
  });

  stage.appendChild(wrap);
  return stage;
}

/* ê²°ê³¼ ë¸”ë¡ */
function createResultBlock(selection, rowsByYear, opts={}) {
  const { compact=false } = opts;
  const container = document.createElement("div");

  const title = document.createElement("div");
  title.className = "result-title";
  title.textContent = `${selection.univ} / ${selection.major}`;
  container.appendChild(title);

  const sub = document.createElement("div");
  sub.className = "result-sub";
  sub.textContent = `[${selection.type}] ${selection.detail} Â· 3ê°œë…„ 70% cut ì…ê²° ìƒìŠ¹ íƒ€ì›Œ`;
  container.appendChild(sub);

  const header = document.createElement("div");
  header.className = "result-header";
  header.textContent = "ğŸ›ï¸ 70% cut ê¸°ì¤€ìœ¼ë¡œ ìµœê·¼ 3ê°œë…„ ì…ê²° íë¦„ì„ â€˜ìƒìŠ¹ íƒ€ì›Œâ€™ë¡œ ì‹œê°í™”í–ˆìŠµë‹ˆë‹¤.";
  container.appendChild(header);

  container.appendChild(createScoreTowerBlock(rowsByYear));

  // ëª¨ë°”ì¼ ìš”ì•½ ì¹´ë“œ + (ì›í•˜ë©´ í¼ì³ì„œ ìƒì„¸ í…Œì´ë¸”)
  if (compact) {
    container.appendChild(createMobileSummary(rowsByYear));

    const d = document.createElement("details");
    d.className = "fold";
    d.innerHTML = `
      <summary>ìì„¸íˆ ë³´ê¸° (í‘œ í¼ì¹˜ê¸°)</summary>
      <div class="inner"></div>
    `;
    d.querySelector(".inner").appendChild(createTableBlock(rowsByYear));
    container.appendChild(d);
  } else {
    const header2 = document.createElement("div");
    header2.className = "result-header";
    header2.style.marginTop = "8px";
    header2.textContent = "ğŸ“Š 3ê°œë…„ 50% Â· 70% Â· ëª¨ì§‘ì¸ì› Â· ê²½ìŸë¥  Â· ì¶©ì›ìˆœìœ„ë¥¼ í•¨ê»˜ í™•ì¸í•´ ë³´ì„¸ìš”. (2025 í•˜ì´ë¼ì´íŠ¸)";
    container.appendChild(header2);

    container.appendChild(createTableBlock(rowsByYear));
  }

  return container;
}

/* í˜„ì¬ ì„ íƒ ê²°ê³¼ ë Œë”ë§ */
function renderCurrentResult(selection) {
  currentResultBox.innerHTML = "";
  if (!selection) {
    const p = document.createElement("p");
    p.className = "empty-text";
    p.innerHTML = "ì•„ì§ ì„ íƒëœ ì „í˜•ì´ ì—†ìŠµë‹ˆë‹¤.<br>ëŒ€í•™ Â· ëª¨ì§‘ë‹¨ìœ„ Â· ì „í˜•ìœ í˜• Â· ì„¸ë¶€ì „í˜•ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.";
    currentResultBox.appendChild(p);
    return;
  }

  const rowsByYear = getRowsForSelection(selection);
  const hasAny = YEARS.some(y => rowsByYear[y]);
  if (!hasAny) {
    const p = document.createElement("p");
    p.className = "empty-text";
    p.textContent = "í•´ë‹¹ ì „í˜•ì— ëŒ€í•œ 3ê°œë…„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    currentResultBox.appendChild(p);
    return;
  }

  currentResultBox.appendChild(createResultBlock(selection, rowsByYear, { compact: isMobile() }));
}

/* ë¹„êµ ëª©ë¡ ë Œë”ë§ */
function renderCompareList() {
  compareListBox.innerHTML = "";

  if (compareSelections.length === 0) {
    compareEmptyText.style.display = "block";
    return;
  }
  compareEmptyText.style.display = "none";

  // ìŠ¬ë¼ì´ë” ì»¨í…Œì´ë„ˆ (ëª¨ë“œì— ë”°ë¼)
  let host;
  if (compareSliderMode) {
    host = document.createElement("div");
    host.className = "compare-slider";
    compareListBox.appendChild(host);
  } else {
    host = compareListBox;
  }

  compareSelections.forEach((sel, index) => {
    const rowsByYear = getRowsForSelection(sel);
    const hasAny = YEARS.some(y => rowsByYear[y]);

    const item = document.createElement("div");
    item.className = "compare-item";

    const header = document.createElement("div");
    header.className = "compare-header";

    const left = document.createElement("div");
    left.className = "compare-label";
    left.innerHTML =
      `<span class="compare-index-badge">${index+1}</span>` +
      `${sel.univ} / ${sel.major}` +
      `<br><small>[${sel.type}] ${sel.detail}</small>`;

    const right = document.createElement("div");
    const btnDel = document.createElement("button");
    btnDel.className = "btn-mini";
    btnDel.textContent = "ì‚­ì œ";
    btnDel.onclick = () => {
      compareSelections.splice(index, 1);
      renderCompareList();
    };
    right.appendChild(btnDel);

    header.appendChild(left);
    header.appendChild(right);
    item.appendChild(header);

    if (!hasAny) {
      const p = document.createElement("p");
      p.className = "empty-text";
      p.textContent = "ì´ ì „í˜•ì€ 3ê°œë…„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      item.appendChild(p);
    } else {
      item.appendChild(createResultBlock(sel, rowsByYear, { compact: isMobile() }));
    }

    if (compareSliderMode) {
      const slide = document.createElement("div");
      slide.className = "compare-slide";
      slide.appendChild(item);
      host.appendChild(slide);
    } else {
      host.appendChild(item);
    }
  });

  // ìŠ¬ë¼ì´ë” ëª¨ë“œì¼ ë•Œ, ê°€ìš´ë°ë¡œ ì‚´ì§ ë§ì¶°ì£¼ê¸°
  if (compareSliderMode) {
    setTimeout(() => {
      const slider = compareListBox.querySelector(".compare-slider");
      if (slider) slider.scrollLeft = 0;
    }, 60);
  }
}

/* ë¹„êµ ì¶”ê°€ ë²„íŠ¼ */
addCompareBtn.addEventListener("click", () => {
  const univ = univSelect.value;
  const major= majorSelect.value;
  const type = typeSelect.value;
  const detail= detailSelect.value;

  if (!univ || !major || !type || !detail) {
    alert("ëŒ€í•™, ëª¨ì§‘ë‹¨ìœ„, ì „í˜•ìœ í˜•, ì„¸ë¶€ì „í˜•ì„ ëª¨ë‘ ì„ íƒí•œ í›„ ë¹„êµë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.");
    return;
  }
  if (compareSelections.length >= 3) {
    alert("ë¹„êµ ëª©ë¡ì€ ìµœëŒ€ 3ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  // ì¤‘ë³µ ë°©ì§€
  const exists = compareSelections.some(s =>
    s.univ===univ && s.major===major && s.type===type && s.detail===detail
  );
  if (exists) {
    alert("ì´ë¯¸ ë¹„êµ ëª©ë¡ì— ìˆëŠ” ì „í˜•ì…ë‹ˆë‹¤.");
    return;
  }

  const sel = { univ, major, type, detail };
  compareSelections.push(sel);

  // 2ê°œ ì´ìƒë¶€í„°ëŠ” ìë™ìœ¼ë¡œ ìŠ¬ë¼ì´ë”ê°€ ë” ë³´ê¸° ì¢‹ì•„ì„œ(íŠ¹íˆ ëª¨ë°”ì¼)
  if (compareSelections.length >= 2 && isMobile()) compareSliderMode = true;

  syncCompareModeUI();
  renderCompareList();
});

/* ì´ˆê¸°í™” ë²„íŠ¼ */
resetBtn.addEventListener("click", () => {
  univSelect.selectedIndex = 0;
  disableSelect(majorSelect, "ëª¨ì§‘ë‹¨ìœ„ ì„ íƒ");
  disableSelect(typeSelect, "ì „í˜•ìœ í˜• ì„ íƒ");
  disableSelect(detailSelect, "ì„¸ë¶€ì „í˜• ì„ íƒ");
  addCompareBtn.disabled = true;
  compareSelections = [];
  compareSliderMode = false;
  syncCompareModeUI();
  renderCurrentResult(null);
  renderCompareList();
});

/* ë¹„êµ ë³´ê¸° í† ê¸€ */
toggleCompareViewBtn.addEventListener("click", () => {
  compareSliderMode = !compareSliderMode;
  syncCompareModeUI();
  renderCompareList();
});

function syncCompareModeUI() {
  compareModePill.textContent = compareSliderMode ? "ìŠ¬ë¼ì´ë“œ ëª¨ë“œ" : "ì„¸ë¡œ ëª¨ë“œ";
  toggleCompareViewBtn.textContent = compareSliderMode ? "â†• ë¹„êµ ì„¸ë¡œ ë³´ê¸°" : "â†” ë¹„êµ ìŠ¬ë¼ì´ë“œ ë³´ê¸°";
}

/* ë°˜ì‘í˜• ë³€ê²½ ì‹œ(íšŒì „ ë“±) ë‹¤ì‹œ ë Œë” */
window.addEventListener("resize", () => {
  // í˜„ì¬ ì„ íƒ ë‹¤ì‹œ ê·¸ë¦¼(ëª¨ë°”ì¼ ìš”ì•½/ìƒì„¸ ìë™ ì „í™˜)
  const univ = univSelect.value;
  const major= majorSelect.value;
  const type = typeSelect.value;
  const detail= detailSelect.value;
  if (univ && major && type && detail) {
    renderCurrentResult({univ, major, type, detail});
  }
  renderCompareList();
});

/* ì´ˆê¸° ì‹¤í–‰ */
loadData();
renderCompareList();
syncCompareModeUI();
</script>
</body>
</html>
